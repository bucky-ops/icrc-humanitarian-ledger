<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - ICRC Supply Chain Platform</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Alpine JS CDN -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <!-- Lucide Icons CDN -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom styles for humanitarian theme */
        .bg-icrc-red {
            background-color: #EE3224;
        }
        .text-icrc-red {
            color: #EE3224;
        }
        .border-icrc-red {
            border-color: #EE3224;
        }
        .bg-deep-navy {
            background-color: #1A202C;
        }
        .text-deep-navy {
            color: #1A202C;
        }
        .bg-slate {
            background-color: #F8FAFC;
        }
    </style>
</head>
<body class="bg-slate min-h-screen flex" x-data="adminApp()">
    <!-- Sidebar Navigation -->
    <aside class="bg-deep-navy text-white w-64 min-h-screen p-6 hidden md:block">
        <div class="mb-10">
            <h2 class="text-xl font-bold flex items-center">
                <i data-lucide="shield-check" class="mr-2"></i>
                ICRC Admin Panel
            </h2>
            <p class="text-gray-400 text-sm mt-1">Enterprise Platform</p>
        </div>

        <nav>
            <ul class="space-y-2">
                <li @click="setActiveView('dashboard')" 
                    :class="activeView === 'dashboard' ? 'bg-icrc-red rounded-lg p-3 flex items-center' : 'hover:bg-gray-700 rounded-lg p-3 flex items-center cursor-pointer'"
                    class="flex items-center">
                    <i data-lucide="home" class="mr-3"></i>
                    <span>Dashboard</span>
                </li>
                <li @click="setActiveView('kits')" 
                    :class="activeView === 'kits' ? 'bg-icrc-red rounded-lg p-3 flex items-center' : 'hover:bg-gray-700 rounded-lg p-3 flex items-center cursor-pointer'"
                    class="flex items-center">
                    <i data-lucide="package" class="mr-3"></i>
                    <span>Medical Kits</span>
                </li>
                <li @click="setActiveView('users')" 
                    :class="activeView === 'users' ? 'bg-icrc-red rounded-lg p-3 flex items-center' : 'hover:bg-gray-700 rounded-lg p-3 flex items-center cursor-pointer'"
                    class="flex items-center">
                    <i data-lucide="users" class="mr-3"></i>
                    <span>User Management</span>
                </li>
                <li @click="setActiveView('approvals')" 
                    :class="activeView === 'approvals' ? 'bg-icrc-red rounded-lg p-3 flex items-center' : 'hover:bg-gray-700 rounded-lg p-3 flex items-center cursor-pointer'"
                    class="flex items-center">
                    <i data-lucide="clipboard-check" class="mr-3"></i>
                    <span>Pending Approvals</span>
                </li>
                <li @click="setActiveView('audit')" 
                    :class="activeView === 'audit' ? 'bg-icrc-red rounded-lg p-3 flex items-center' : 'hover:bg-gray-700 rounded-lg p-3 flex items-center cursor-pointer'"
                    class="flex items-center">
                    <i data-lucide="file-search" class="mr-3"></i>
                    <span>Audit Logs</span>
                </li>
                <li @click="setActiveView('network')" 
                    :class="activeView === 'network' ? 'bg-icrc-red rounded-lg p-3 flex items-center' : 'hover:bg-gray-700 rounded-lg p-3 flex items-center cursor-pointer'"
                    class="flex items-center">
                    <i data-lucide="network" class="mr-3"></i>
                    <span>Network Status</span>
                </li>
                <li @click="setActiveView('reports')" 
                    :class="activeView === 'reports' ? 'bg-icrc-red rounded-lg p-3 flex items-center' : 'hover:bg-gray-700 rounded-lg p-3 flex items-center cursor-pointer'"
                    class="flex items-center">
                    <i data-lucide="file-text" class="mr-3"></i>
                    <span>Reports</span>
                </li>
            </ul>
        </nav>

        <div class="mt-auto">
            <div class="flex items-center">
                <div class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center mr-3">
                    <span class="text-deep-navy font-bold" x-text="currentUser.initials">HQ</span>
                </div>
                <div>
                    <p class="font-medium" x-text="currentUser.name">ICRC Admin</p>
                    <p class="text-gray-400 text-sm" x-text="currentUser.role">Headquarters</p>
                </div>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 p-6">
        <!-- Header -->
        <header class="mb-8">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-deep-navy" x-text="getViewTitle()">Admin Dashboard</h1>
                    <p class="text-gray-600">Manage the ICRC Supply Chain Platform</p>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="flex items-center">
                        <span :class="stats.status === 'Online' ? 'bg-green-500' : 'bg-red-500'"
                              class="w-3 h-3 rounded-full mr-2 animate-pulse"></span>
                        <p class="text-2xl font-bold" x-text="stats.status">Checking...</p>
                    </div>
                    <button
                        @click="logout()"
                        class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-md flex items-center"
                    >
                        <i data-lucide="log-out" class="mr-2"></i>
                        <span>Logout</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Dashboard View -->
        <div x-show="activeView === 'dashboard'" x-transition>
            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-white rounded-xl shadow p-6 border-l-4 border-icrc-red">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-gray-500 text-sm font-medium">Total Kits</p>
                            <p class="text-3xl font-bold text-deep-navy mt-1" x-text="stats.totalKits"></p>
                        </div>
                        <div class="bg-red-100 p-3 rounded-lg">
                            <i data-lucide="package" class="text-icrc-red"></i>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow p-6 border-l-4 border-blue-500">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-gray-500 text-sm font-medium">Total Users</p>
                            <p class="text-3xl font-bold text-deep-navy mt-1" x-text="stats.totalUsers"></p>
                        </div>
                        <div class="bg-blue-100 p-3 rounded-lg">
                            <i data-lucide="users" class="text-blue-500"></i>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow p-6 border-l-4 border-green-500">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-gray-500 text-sm font-medium">Network Nodes</p>
                            <p class="text-3xl font-bold text-deep-navy mt-1" x-text="stats.networkNodes"></p>
                        </div>
                        <div class="bg-green-100 p-3 rounded-lg">
                            <i data-lucide="network" class="text-green-500"></i>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow p-6 border-l-4 border-yellow-500">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-gray-500 text-sm font-medium">Compliance Rate</p>
                            <p class="text-3xl font-bold text-deep-navy mt-1" x-text="stats.complianceRate + '%'"></p>
                        </div>
                        <div class="bg-yellow-100 p-3 rounded-lg">
                            <i data-lucide="shield-check" class="text-yellow-500"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white rounded-xl shadow p-6">
                    <h3 class="text-lg font-medium text-deep-navy mb-4">Recent Kit Additions</h3>
                    <div class="space-y-4">
                        <template x-for="kit in recentKits" :key="kit.id">
                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                <div>
                                    <p class="font-medium" x-text="kit.id"></p>
                                    <p class="text-sm text-gray-500" x-text="kit.type + ' • ' + kit.location"></p>
                                </div>
                                <span class="text-sm text-gray-500" x-text="new Date(kit.timestamp).toLocaleTimeString()"></span>
                            </div>
                        </template>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow p-6">
                    <h3 class="text-lg font-medium text-deep-navy mb-4">Recent User Registrations</h3>
                    <div class="space-y-4">
                        <template x-for="user in recentUsers" :key="user.id">
                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                <div>
                                    <p class="font-medium" x-text="user.email"></p>
                                    <p class="text-sm text-gray-500" x-text="user.role"></p>
                                </div>
                                <span class="text-sm text-gray-500" x-text="new Date(user.createdAt).toLocaleDateString()"></span>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>

        <!-- Medical Kits View -->
        <div x-show="activeView === 'kits'" x-transition>
            <div class="mb-6 flex justify-between items-center">
                <div class="relative w-1/3">
                    <input
                        type="text"
                        placeholder="Search kits..."
                        x-model="kitSearchTerm"
                        class="w-full p-3 pr-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-icrc-red focus:border-transparent"
                    />
                    <i data-lucide="search" class="absolute right-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-gray-400"></i>
                </div>
                <button @click="showAddKitModal = true" class="bg-icrc-red hover:bg-red-700 text-white px-4 py-2 rounded-md flex items-center">
                    <i data-lucide="plus" class="mr-2"></i>
                    <span>Add Kit</span>
                </button>
            </div>

            <div class="bg-white rounded-xl shadow overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kit ID</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Location</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Temperature</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <template x-for="kit in filteredKits" :key="kit.data.kitID">
                                <tr class="border-b hover:bg-gray-50">
                                    <td class="px-6 py-4 whitespace-nowrap font-mono text-sm" x-text="kit.data.kitID"></td>
                                    <td class="px-6 py-4 whitespace-nowrap" x-text="kit.data.type"></td>
                                    <td class="px-6 py-4 whitespace-nowrap" x-text="kit.data.location"></td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span x-text="kit.data.temperature + '°C'"
                                              :class="kit.data.temperature > 8 ? 'text-red-600 font-bold' : 'text-green-600'">
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span :class="kit.data.temperature > 8 ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'" 
                                              class="px-2 py-1 rounded-full text-xs font-semibold" 
                                              x-text="kit.data.temperature > 8 ? 'HIGH RISK' : 'SAFE'"></span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                                        <button @click="viewKitDetails(kit)" class="text-icrc-red hover:text-red-700 mr-3">View</button>
                                        <button @click="deleteKit(kit)" class="text-red-600 hover:text-red-800">Delete</button>
                                    </td>
                                </tr>
                            </template>

                            <tr x-show="filteredKits.length === 0">
                                <td colspan="6" class="px-6 py-4 text-center text-sm text-gray-500">
                                    <span x-text="kitSearchTerm ? 'No kits match your search.' : 'Loading kits...'"></span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- User Management View -->
        <div x-show="activeView === 'users'" x-transition>
            <div class="mb-6 flex justify-between items-center">
                <div class="relative w-1/3">
                    <input
                        type="text"
                        placeholder="Search users..."
                        x-model="userSearchTerm"
                        class="w-full p-3 pr-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-icrc-red focus:border-transparent"
                    />
                    <i data-lucide="search" class="absolute right-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-gray-400"></i>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last Login</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <template x-for="user in filteredUsers" :key="user.id">
                                <tr class="border-b hover:bg-gray-50">
                                    <td class="px-6 py-4 whitespace-nowrap" x-text="user.email"></td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <select x-model="user.role" 
                                                @change="updateUserRole(user.id, user.role)" 
                                                class="border border-gray-300 rounded px-2 py-1 text-sm">
                                            <option value="user">Field Staff</option>
                                            <option value="admin">Admin</option>
                                            <option value="logistics">Logistics Officer</option>
                                            <option value="medical">Field Medical Officer</option>
                                            <option value="auditor">External Auditor</option>
                                        </select>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <select x-model="user.status" 
                                                @change="updateUserStatus(user.id, user.status)" 
                                                class="border border-gray-300 rounded px-2 py-1 text-sm">
                                            <option value="Pending">Pending</option>
                                            <option value="Approved">Approved</option>
                                            <option value="Suspended">Suspended</option>
                                        </select>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="new Date(user.createdAt).toLocaleDateString()"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="user.lastLogin ? new Date(user.lastLogin).toLocaleDateString() : 'Never'"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                                        <button @click="deleteUser(user.id)" class="text-red-600 hover:text-red-800 mr-2">Delete</button>
                                        <button @click="rollbackUserActions(user.id)" class="text-yellow-600 hover:text-yellow-800">Rollback</button>
                                    </td>
                                </tr>
                            </template>

                            <tr x-show="filteredUsers.length === 0">
                                <td colspan="6" class="px-6 py-4 text-center text-sm text-gray-500">
                                    <span x-text="userSearchTerm ? 'No users match your search.' : 'Loading users...'"></span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Pending Approvals View -->
        <div x-show="activeView === 'approvals'" x-transition>
            <div class="mb-6">
                <h2 class="text-xl font-bold text-deep-navy mb-4">Pending Access Requests</h2>
            </div>

            <div class="bg-white rounded-xl shadow overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Staff Email</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Requested Role</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Request Date</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <template x-for="user in pendingUsers" :key="user.id">
                                <tr class="border-b hover:bg-gray-50">
                                    <td class="px-6 py-4 whitespace-nowrap font-medium" x-text="user.email"></td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <select x-model="user.assignedRole" 
                                                class="border border-gray-300 rounded px-2 py-1 text-sm">
                                            <option value="user">Field Staff</option>
                                            <option value="logistics">Logistics Officer</option>
                                            <option value="medical">Field Medical Officer</option>
                                            <option value="auditor">External Auditor</option>
                                        </select>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="px-2 py-1 rounded-full text-xs font-semibold bg-yellow-100 text-yellow-800">Pending</span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="new Date(user.createdAt).toLocaleDateString()"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm space-x-2">
                                        <button @click="approveUser(user.id, user.assignedRole)" class="bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700">Approve</button>
                                        <button @click="rejectUser(user.id)" class="bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700">Reject</button>
                                    </td>
                                </tr>
                            </template>

                            <tr x-show="pendingUsers.length === 0">
                                <td colspan="5" class="px-6 py-4 text-center text-sm text-gray-500">
                                    <span>No pending access requests</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Audit Logs View -->
        <div x-show="activeView === 'audit'" x-transition>
            <div class="mb-6">
                <h2 class="text-xl font-bold text-deep-navy mb-4">Global Activity Audit</h2>
                <button @click="refreshLogs()" class="bg-icrc-red hover:bg-red-700 text-white px-4 py-2 rounded-md flex items-center">
                    <i data-lucide="refresh-cw" class="mr-2"></i>
                    <span>Refresh Logs</span>
                </button>
            </div>

            <div class="bg-white rounded-xl shadow overflow-hidden">
                <div class="overflow-x-auto max-h-96">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Timestamp</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Details</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <template x-for="log in auditLogs" :key="log">
                                <tr class="border-b hover:bg-gray-50">
                                    <td class="px-6 py-4 whitespace-nowrap text-sm" x-text="log.split(']')[0].substring(1)"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium" x-text="extractUserFromLog(log)"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm" x-text="extractActionFromLog(log)"></td>
                                    <td class="px-6 py-4 text-sm" x-text="extractDetailsFromLog(log)"></td>
                                </tr>
                            </template>

                            <tr x-show="auditLogs.length === 0">
                                <td colspan="4" class="px-6 py-4 text-center text-sm text-gray-500">
                                    <span>Loading audit logs...</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Network Status View -->
        <div x-show="activeView === 'network'" x-transition>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                <div class="bg-white rounded-xl shadow p-6">
                    <h3 class="text-lg font-medium text-deep-navy mb-4">Node Health</h3>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center p-3 bg-green-50 rounded-lg">
                            <span>Main Node</span>
                            <span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs font-semibold">Healthy</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-green-50 rounded-lg">
                            <span>Backup Node 1</span>
                            <span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs font-semibold">Healthy</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-yellow-50 rounded-lg">
                            <span>Backup Node 2</span>
                            <span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full text-xs font-semibold">Warning</span>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow p-6">
                    <h3 class="text-lg font-medium text-deep-navy mb-4">Blockchain Sync</h3>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <span>Total Blocks</span>
                            <span class="font-medium" x-text="stats.blockchainHeight"></span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span>Sync Status</span>
                            <span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs font-semibold">Synced</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span>Last Sync</span>
                            <span class="text-sm text-gray-500" x-text="stats.lastSyncTime"></span>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow p-6">
                    <h3 class="text-lg font-medium text-deep-navy mb-4">Security Status</h3>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <span>Firewall</span>
                            <span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs font-semibold">Active</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span>DDoS Protection</span>
                            <span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs font-semibold">Active</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span>Certificate Expiry</span>
                            <span class="text-sm text-gray-500">30 days</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reports View -->
        <div x-show="activeView === 'reports'" x-transition>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white rounded-xl shadow p-6">
                    <h3 class="text-lg font-medium text-deep-navy mb-4">Compliance Report</h3>
                    <div class="space-y-4">
                        <div>
                            <div class="flex justify-between mb-1">
                                <span>Temperature Compliance</span>
                                <span x-text="stats.tempCompliance + '%'"></span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-green-600 h-2 rounded-full" :style="`width: ${stats.tempCompliance}%`"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between mb-1">
                                <span>Location Tracking</span>
                                <span x-text="stats.locCompliance + '%'"></span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-blue-600 h-2 rounded-full" :style="`width: ${stats.locCompliance}%`"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between mb-1">
                                <span>Data Integrity</span>
                                <span x-text="stats.integrityCompliance + '%'"></span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-yellow-600 h-2 rounded-full" :style="`width: ${stats.integrityCompliance}%`"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow p-6">
                    <h3 class="text-lg font-medium text-deep-navy mb-4">Risk Assessment</h3>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center p-3 bg-red-50 rounded-lg">
                            <span>High Risk Shipments</span>
                            <span class="bg-red-100 text-red-800 px-2 py-1 rounded-full text-xs font-semibold" x-text="stats.highRiskCount"></span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-yellow-50 rounded-lg">
                            <span>Medium Risk Shipments</span>
                            <span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full text-xs font-semibold" x-text="stats.mediumRiskCount"></span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-green-50 rounded-lg">
                            <span>Low Risk Shipments</span>
                            <span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs font-semibold" x-text="stats.lowRiskCount"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Add Kit Modal -->
    <div x-show="showAddKitModal" 
         class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" 
         aria-labelledby="modal-title" 
         role="dialog" 
         aria-modal="true">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-md p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium text-deep-navy" id="modal-title">Add New Medical Kit</h3>
                <button @click="showAddKitModal = false" class="text-gray-500 hover:text-gray-700">
                    <i data-lucide="x" class="h-6 w-6"></i>
                </button>
            </div>
            
            <form @submit.prevent="addKit">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Kit ID</label>
                        <input type="text" 
                               x-model="newKit.kitID" 
                               required
                               class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-icrc-red focus:border-transparent">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Type</label>
                        <select x-model="newKit.type" 
                                required
                                class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-icrc-red focus:border-transparent">
                            <option value="">Select Type</option>
                            <option value="Emergency">Emergency</option>
                            <option value="Surgical">Surgical</option>
                            <option value="Medication">Medication</option>
                            <option value="Vaccination">Vaccination</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Origin</label>
                        <input type="text" 
                               x-model="newKit.origin" 
                               required
                               class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-icrc-red focus:border-transparent">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Current Location</label>
                        <input type="text" 
                               x-model="newKit.location" 
                               required
                               class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-icrc-red focus:border-transparent">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Temperature (°C)</label>
                        <input type="number" 
                               x-model.number="newKit.temperature" 
                               required
                               step="0.1"
                               class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-icrc-red focus:border-transparent">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Flight Number (optional)</label>
                        <input type="text" 
                               x-model="newKit.flightNumber" 
                               class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-icrc-red focus:border-transparent">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Destination (optional)</label>
                        <input type="text" 
                               x-model="newKit.destination" 
                               class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-icrc-red focus:border-transparent">
                    </div>
                </div>
                
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" 
                            @click="showAddKitModal = false" 
                            class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                        Cancel
                    </button>
                    <button type="submit" 
                            class="px-4 py-2 bg-icrc-red hover:bg-red-700 text-white rounded-md">
                        Add Kit
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // Admin application logic
        function adminApp() {
            return {
                activeView: 'dashboard',
                ledger: [],
                users: [],
                stats: {
                    totalKits: 0,
                    totalUsers: 0,
                    networkNodes: 3,
                    complianceRate: 98,
                    blockchainHeight: 0,
                    lastSyncTime: 'Just now',
                    tempCompliance: 95,
                    locCompliance: 98,
                    integrityCompliance: 100,
                    highRiskCount: 3,
                    mediumRiskCount: 7,
                    lowRiskCount: 42
                },
                currentUser: {
                    name: 'ICRC Admin',
                    role: 'Administrator',
                    initials: 'HQ'
                },
                kitSearchTerm: '',
                userSearchTerm: '',
                showAddKitModal: false,
                newKit: {
                    kitID: '',
                    type: '',
                    origin: '',
                    location: '',
                    temperature: '',
                    flightNumber: '',
                    destination: ''
                },
                recentKits: [],
                recentUsers: [],
                pendingUsers: [],
                auditLogs: [],
                
                get filteredKits() {
                    if (!this.kitSearchTerm) return this.ledger;
                    return this.ledger.filter(kit =>
                        kit.data.kitID.toLowerCase().includes(this.kitSearchTerm.toLowerCase()) ||
                        kit.data.type.toLowerCase().includes(this.kitSearchTerm.toLowerCase()) ||
                        kit.data.location.toLowerCase().includes(this.kitSearchTerm.toLowerCase())
                    );
                },
                
                get filteredUsers() {
                    if (!this.userSearchTerm) return this.users;
                    return this.users.filter(user =>
                        user.email.toLowerCase().includes(this.userSearchTerm.toLowerCase()) ||
                        user.role.toLowerCase().includes(this.userSearchTerm.toLowerCase())
                    );
                },
                
                setActiveView(view) {
                    this.activeView = view;
                },
                
                getViewTitle() {
                    switch(this.activeView) {
                        case 'dashboard': return 'Admin Dashboard';
                        case 'kits': return 'Medical Kits Management';
                        case 'users': return 'User Management';
                        case 'network': return 'Network Status';
                        case 'reports': return 'Reports & Analytics';
                        default: return 'Admin Dashboard';
                    }
                },
                
                async checkHealth() {
                    try {
                        const res = await fetch('/health');
                        const data = await res.json();
                        this.stats.status = data.status === 'OK' ? 'Online' : 'Error';
                    } catch (err) {
                        this.stats.status = 'Offline';
                    }
                },
                
                async fetchLedger() {
                    try {
                        const res = await fetch('/ledger');
                        const data = await res.json();
                        this.ledger = Array.isArray(data.blocks) ? data.blocks : (data.chain || data.ledger || []);
                        this.stats.totalKits = this.ledger.length;
                        this.stats.blockchainHeight = this.ledger.length;
                        
                        // Get recent kits (last 5)
                        this.recentKits = this.ledger.slice(-5).reverse().map(block => ({
                            id: block.data.kitID,
                            type: block.data.type,
                            location: block.data.location,
                            timestamp: block.timestamp
                        }));
                    } catch (err) {
                        console.error("❌ Failed to sync ledger:", err);
                    }
                },
                
                async fetchUsers() {
                    try {
                        const token = localStorage.getItem('token');
                        if (!token) {
                            window.location.href = '/login';
                            return;
                        }
                        
                        const res = await fetch('/users', {
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });
                        
                        if (res.ok) {
                            const data = await res.json();
                            this.users = data.users;
                            this.stats.totalUsers = data.users.length;
                            
                            // Get recent users (last 5)
                            this.recentUsers = data.users.slice(-5).reverse();
                        } else {
                            // If unauthorized, redirect to login
                            if (res.status === 401 || res.status === 403) {
                                window.location.href = '/login';
                            }
                        }
                    } catch (err) {
                        console.error("❌ Failed to fetch users:", err);
                    }
                },
                
                async addKit() {
                    try {
                        const token = localStorage.getItem('token');
                        if (!token) {
                            window.location.href = '/login';
                            return;
                        }
                        
                        const res = await fetch('/add-kit', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify(this.newKit)
                        });
                        
                        if (res.ok) {
                            alert('Kit added successfully!');
                            this.showAddKitModal = false;
                            this.newKit = {
                                kitID: '',
                                type: '',
                                origin: '',
                                location: '',
                                temperature: '',
                                flightNumber: '',
                                destination: ''
                            };
                            // Refresh ledger
                            await this.fetchLedger();
                        } else {
                            const data = await res.json();
                            alert(data.message || 'Failed to add kit');
                        }
                    } catch (err) {
                        console.error("❌ Failed to add kit:", err);
                        alert('Network error. Please try again.');
                    }
                },
                
                async updateUserRole(userId, newRole) {
                    try {
                        const token = localStorage.getItem('token');
                        if (!token) {
                            window.location.href = '/login';
                            return;
                        }
                        
                        const res = await fetch(`/users/${userId}/role`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({ role: newRole })
                        });
                        
                        if (res.ok) {
                            alert('User role updated successfully!');
                        } else {
                            const data = await res.json();
                            alert(data.message || 'Failed to update user role');
                        }
                    } catch (err) {
                        console.error("❌ Failed to update user role:", err);
                        alert('Network error. Please try again.');
                    }
                },
                
                async deleteUser(userId) {
                    if (!confirm('Are you sure you want to delete this user?')) {
                        return;
                    }
                    
                    try {
                        const token = localStorage.getItem('token');
                        if (!token) {
                            window.location.href = '/login';
                            return;
                        }
                        
                        const res = await fetch(`/users/${userId}`, {
                            method: 'DELETE',
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });
                        
                        if (res.ok) {
                            alert('User deleted successfully!');
                            // Refresh users list
                            await this.fetchUsers();
                        } else {
                            const data = await res.json();
                            alert(data.message || 'Failed to delete user');
                        }
                    } catch (err) {
                        console.error("❌ Failed to delete user:", err);
                        alert('Network error. Please try again.');
                    }
                },
                
                async deleteKit(kit) {
                    if (!confirm(`Are you sure you want to delete kit ${kit.data.kitID}?`)) {
                        return;
                    }

                    // In a real implementation, you would have an endpoint to delete a kit
                    // For now, we'll just show an alert
                    alert(`Kit ${kit.data.kitID} would be deleted in a real implementation`);
                },

                async updateUserStatus(userId, newStatus) {
                    try {
                        const token = localStorage.getItem('token');
                        if (!token) {
                            window.location.href = '/login';
                            return;
                        }

                        const res = await fetch('/admin/set-user-status', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({ userId, status: newStatus })
                        });

                        if (res.ok) {
                            alert('User status updated successfully!');
                        } else {
                            const data = await res.json();
                            alert(data.message || 'Failed to update user status');
                        }
                    } catch (err) {
                        console.error("❌ Failed to update user status:", err);
                        alert('Network error. Please try again.');
                    }
                },

                async approveUser(userId, role) {
                    try {
                        const token = localStorage.getItem('token');
                        if (!token) {
                            window.location.href = '/login';
                            return;
                        }

                        const res = await fetch('/admin/approve-user', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({ userId, role })
                        });

                        if (res.ok) {
                            alert('User approved successfully!');
                            // Refresh pending users list
                            await this.fetchPendingUsers();
                        } else {
                            const data = await res.json();
                            alert(data.message || 'Failed to approve user');
                        }
                    } catch (err) {
                        console.error("❌ Failed to approve user:", err);
                        alert('Network error. Please try again.');
                    }
                },

                async rejectUser(userId) {
                    try {
                        const token = localStorage.getItem('token');
                        if (!token) {
                            window.location.href = '/login';
                            return;
                        }

                        const res = await fetch('/admin/set-user-status', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({ userId, status: 'Suspended' })
                        });

                        if (res.ok) {
                            alert('User request rejected and suspended!');
                            // Refresh pending users list
                            await this.fetchPendingUsers();
                        } else {
                            const data = await res.json();
                            alert(data.message || 'Failed to reject user');
                        }
                    } catch (err) {
                        console.error("❌ Failed to reject user:", err);
                        alert('Network error. Please try again.');
                    }
                },

                async rollbackUserActions(userId) {
                    alert(`Rollback functionality for user ${userId} would be implemented in a full system`);
                },

                async fetchPendingUsers() {
                    try {
                        const token = localStorage.getItem('token');
                        if (!token) {
                            window.location.href = '/login';
                            return;
                        }

                        const res = await fetch('/admin/pending-users', {
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });

                        if (res.ok) {
                            const data = await res.json();
                            this.pendingUsers = data.pendingUsers;
                        } else {
                            // If unauthorized, redirect to login
                            if (res.status === 401 || res.status === 403) {
                                window.location.href = '/login';
                            }
                        }
                    } catch (err) {
                        console.error("❌ Failed to fetch pending users:", err);
                    }
                },

                async fetchAuditLogs() {
                    try {
                        const token = localStorage.getItem('token');
                        if (!token) {
                            window.location.href = '/login';
                            return;
                        }

                        const res = await fetch('/admin/logs', {
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });

                        if (res.ok) {
                            const data = await res.json();
                            this.auditLogs = data.logs;
                        } else {
                            // If unauthorized, redirect to login
                            if (res.status === 401 || res.status === 403) {
                                window.location.href = '/login';
                            }
                        }
                    } catch (err) {
                        console.error("❌ Failed to fetch audit logs:", err);
                    }
                },

                refreshLogs() {
                    this.fetchAuditLogs();
                },

                extractUserFromLog(log) {
                    // Extract user email from log entry
                    const match = log.match(/EMAIL: ([^|]+)/);
                    return match ? match[1].trim() : 'Unknown';
                },

                extractActionFromLog(log) {
                    // Extract action from log entry
                    const match = log.match(/ACTION: ([^|]+)/);
                    return match ? match[1].trim() : 'Unknown';
                },

                extractDetailsFromLog(log) {
                    // Extract details from log entry
                    const match = log.match(/DETAILS: (.+)/);
                    return match ? match[1].trim() : 'No details';
                },

                viewKitDetails(kit) {
                    // In a real implementation, you would navigate to the kit details page
                    alert(`Viewing details for kit ${kit.data.kitID}`);
                },

                logout() {
                    fetch('/logout', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    }).then(response => {
                        if (response.ok) {
                            window.location.href = '/login';
                        } else {
                            window.location.href = '/login'; // Redirect anyway
                        }
                    }).catch(error => {
                        window.location.href = '/login'; // Redirect anyway
                    });
                },

                async init() {
                    console.log("🚀 Admin App initialized");

                    // Check if user is logged in
                    const token = localStorage.getItem('token');
                    if (!token) {
                        window.location.href = '/login';
                        return;
                    }

                    await this.checkHealth();
                    await this.fetchLedger();
                    await this.fetchUsers();
                    await this.fetchPendingUsers();
                    await this.fetchAuditLogs();

                    // Auto-refresh every 30 seconds
                    setInterval(async () => {
                        await this.checkHealth();
                        await this.fetchLedger();
                        await this.fetchUsers();
                        await this.fetchPendingUsers();
                        await this.fetchAuditLogs();
                    }, 30000);
                }
            }
        }
    </script>
</body>
</html>